<!DOCTYPE html>
<html>
<head>
	<title>WebGL Playground</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="gl.js"></script>
	<script src="Math.js"></script>
	<script src="Shaders.js"></script>
	<script src="RenderLoop.js"></script>
	<script src="Transform.js"></script>
	<script src="Modal.js"></script>
	<script src="Primatives.js"></script>
	<script src="Camera.js"></script>
	<script src="Shaders_Extra.js"></script>


	<script>
		//Global variables init
		var gl, gRLoop,	gShader, gModal, gCamera, gCameraCtrl;
		var gGridShader, gGridModal;
		var gModal2, gModal3;

		window.addEventListener("load",function(){
			//Main Setup
			gl = GLInstance("glcanvas").fFitScreen(0.95,0.9).fClear();

			gCamera = new Camera(gl);
			gCamera.transform.position.set(0,1,3);
			gCameraCtrl = new CameraController(gl,gCamera);

			//Load texture
			//gl.fLoadTexture("tex001", document.getElementById("imgTex"));

			gGridShader = new GridAxisShader(gl,gCamera.projectionMatrix);
			gGridModal = Primatives.GridAxis.createModal(gl,true);

			gShader = new TestShader(gl,gCamera.projectionMatrix)
			//.setTexture(gl.mTextureCache["tex001"]);
			
			gModal = Primatives.CubeBad.createModal(gl);
			gModal.setPosition(0,0.6,0);

			//Old Code
/*			gShader = new TestShader(gl,[ 0.8,0.8,0.8,  1,0,0,  0,1,0,  0,0,1 ]); //Gray,Red,Green,Blue
			gShader.activate().setPerspective(gCamera.projectionMatrix).deactivate();


			gModal = new Modal(Primatives.GridAxis.createMesh(gl,false));
			gModal.setScale(0.4,0.4,0.4).setRotation(0,0,45).setPosition(0.4,-0.8,0);*/

			//Start Rendering
			RLoop = new RenderLoop(onRender,60).start();
		});

		var gPointSize = 0;
			gPSizeStep = 3,
			gAngle = 0,
			gAngleStep = (Math.PI / 180.0) * 90,
			gRadius = 0,
			gRadiusStep = 0.1;



		function onRender(dt){
			gCamera.updateViewMatrix();
			gl.fClear();	

			gGridShader.activate().setCameraMatrix(gCamera.viewMatrix).renderModal(gGridModal.preRender());

			gShader.activate()//.preRender()
				.setCameraMatrix(gCamera.viewMatrix)
				.setTime(performance.now())
				.renderModal(gModal.preRender());
		}

		class TestShader extends Shader{
			constructor(gl,pMatrix){
				var vertSrc = ShaderUtil.domShaderSrc("vertex_shader"),
					fragSrc = ShaderUtil.domShaderSrc("fragment_shader");
				super(gl,vertSrc,fragSrc);

				this.uniformLoc.time = gl.getUniformLocation(this.program, "uTime");

				var uColor = gl.getUniformLocation(this.program, "uColor");
				gl.uniform3fv(uColor, new Float32Array(GlUtil.rgbArray("#FF0000","00FF00", "0000FF", "909090", "C0C0C0", "404040")));

				//Standrd Uniforms
				this.setPerspective(pMatrix);
				this.mainTexture = -1;
				gl.useProgram(null); //Done setting up shader
			}
			setTime(t){ this.gl.uniform1f(this.uniformLoc.time,t); return this;}
			setTexture(texID){this.mainTexture=texID; return this;}

			preRender(){
				this.gl.activeTexture(this.gl.TEXTURE0);
				this.gl.bindTexture(this.gl.TEXTURE_2D, this.mainTexture);
				this.gl.uniform1i(this.uniformLoc.mainTexture,0);

				return this;
			}
		}
	</script>
</head>
<body>
	<div>
		<canvas id="glcanvas"></canvas>
	</div>
	<img src="UV_Grid_Lrg.jpg" id="imgTex" style="display: none;">
	<script id="vertex_shader" type="x-shader/x-vertex">#version 300 es
		in vec4 a_position;	//Standard position data.
		in vec2 a_uv;

		uniform mat4 uPMatrix;
		uniform mat4 uMVMatrix;
		uniform mat4 uCameraMatrix;

		uniform vec3 uColor[6];
		uniform float uTime;

		out lowp vec4 color;
		out highp vec2 texCoord;

		void main(void){
			texCoord = a_uv;
			color = vec4(uColor[int(a_position.w)],1.0);
			gl_Position = uPMatrix * uCameraMatrix * uMVMatrix * vec4(a_position.xyz, 1.0); 
		}
	</script>
	<script id="fragment_shader" type="x-shader/x-fragment">#version 300 es
		precision mediump float;

		in vec4 color;
		in highp vec2 texCoord;
		uniform sampler2D uMainTex;

		out vec4 finalColor;
		void main(void){

			finalColor = color;
			//texture(uMainTex, vec2(texCoord.s, texCoord.t));

			//circle
			/*vec2 delta = uv - vec2(0.5,0.5); //delta position from center;
			float dist = 0.5 - sqrt(delta.x*delta.x + delta.y*delta.y);
			float border = 0.1;
			float a = 0.0;
			if(dist > border) a = 0.0;
			else if(dist > 0.0) a = 1.0;
			finalColor = vec4(0,0,0,a);*/
		}
	</script>
</body>
</html>