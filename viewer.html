<!DOCTYPE html>
<html>
<head>
	<title>WebGL Playground</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="gl.js"></script>
	<script src="Math.js"></script>
	<script src="Shaders.js"></script>
	<script src="RenderLoop.js"></script>
	<script src="Transform.js"></script>
	<script src="Modal.js"></script>
	<script src="Primatives.js"></script>
	<script src="Camera.js"></script>

	<script>
		//Global variables init
		var gl, gRLoop,	gShader, gModal, gCamera, gCameraCtrl;
		var gGridShader, gGridModal;

		window.addEventListener("load",function(){
			//Main Setup
			gl = GLInstance("glcanvas").fSetSize(500,500).fClear();

			gCamera = new Camera(gl);
			gCamera.transform.position.set(0,1,3);
			gCameraCtrl = new CameraController(gl,gCamera);

			gShader = new TestShader(gl,[ 0.8,0.8,0.8,  1,0,0,  0,1,0,  0,0,1 ]); //Gray,Red,Green,Blue
			gShader.activate().setPerspective(gCamera.projectionMatrix).deactivate();


			gModal = new Modal(Primatives.GridAxis.createMesh(gl,false));
			gModal.setScale(0.4,0.4,0.4).setRotation(0,0,45).setPosition(0.4,-0.8,0);

			//Start Rendering
			RLoop = new RenderLoop(onRender).start();
		});

		var gPointSize = 0;
			gPSizeStep = 3,
			gAngle = 0,
			gAngleStep = (Math.PI / 180.0) * 90,
			gRadius = 0,
			gRadiusStep = 0.1;



		function onRender(dt){
			gCamera.updateViewMatrix();
			gl.fClear();	

			gShader.activate().setCameraMatrix(gCamera.viewMatrix).renderModal(gModal.preRender());
		}

		class TestShader extends Shader{
			constructor(gl, aryColor){
				var vertSrc = ShaderUtil.domShaderSrc("vertex_shader"),
					fragSrc = ShaderUtil.domShaderSrc("fragment_shader");
				super(gl,vertSrc,fragSrc);

				var uColor	= gl.getUniformLocation(this.program,"uColor");

				gl.uniform3fv(uColor, aryColor);

				gl.useProgram(null); //Done setting up shader
			}
		}
	</script>
</head>
<body>
	<div>
		<canvas id="glcanvas"></canvas>
	</div>
	<script id="vertex_shader" type="x-shader/x-vertex">#version 300 es
		in vec3 a_position;
		layout(location=4) in float a_color;
		
		uniform mat4 uPMatrix;
		uniform mat4 uMVMatrix;
		uniform mat4 uCameraMatrix;

		uniform vec3 uColor[4];

		out lowp vec4 color;

		void main(void){
			color = vec4(uColor[int(a_color)],1.0);
			gl_Position = uPMatrix * uCameraMatrix * uMVMatrix * vec4(a_position,1.0);
		}
	</script>
	<script id="fragment_shader" type="x-shader/x-fragment">#version 300 es
		precision mediump float;

		in vec4 color;
		out vec4 finalColor;
		
		void main(void) {
			finalColor = color;
		}
	</script>
</body>
</html>