<!DOCTYPE html>
<html>
<head>
	<title>WebGL Playground</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="gl.js"></script>
	<script src="Math.js"></script>
	<script src="Shaders.js"></script>
	<script src="RenderLoop.js"></script>
	<script src="Transform.js"></script>
	<script src="Modal.js"></script>
	<script src="Primatives.js"></script>
	<script>
		//Global variables init
		var gl, gRLoop,	gShader, gModal;

		window.addEventListener("load",function(){
			//Main Setup
			gl = GLInstance("glcanvas").fSetSize(500,500).fClear();
			gShader = new TestShader(gl,[ 0.8,0.8,0.8,  1,0,0,  0,1,0,  0,0,1 ]); //Gray,Red,Green,Blue
			

			gModal = new Modal(Primatives.GridAxis.createMesh(gl));
			gModal.setScale(0.4,0.4,0.4).setRotation(0,0,45).setPosition(0.4,-0.8,0);

			//Start Rendering
			RLoop = new RenderLoop(onRender).start();
		});

		var gPointSize = 0;
			gPSizeStep = 3,
			gAngle = 0,
			gAngleStep = (Math.PI / 180.0) * 90,
			gRadius = 0,
			gRadiusStep = 0.1;



		function onRender(dt){
			gl.fClear();	
			var p = gModal.transform.position,
			angle = Math.atan2(p.y,p.x)  + (1*dt),
			radius = Math.sqrt(p.x * p.x + p.y * p.y),
			scale = Math.max(0.2,  Math.abs(Math.sin(angle)) * 1.2  );

			gShader.activate().renderModal(
					gModal.setScale( scale, scale/4, 1)
							.setPosition( radius * Math.cos(angle), radius * Math.sin(angle), 0 )
							.addRotation( 30 * dt, 60 * dt, 15 * dt )
							.preRender()
			);
		}

		class TestShader extends Shader{
			constructor(gl, aryColor){
				var vertSrc = ShaderUtil.domShaderSrc("vertex_shader"),
					fragSrc = ShaderUtil.domShaderSrc("fragment_shader");
				super(gl,vertSrc,fragSrc);

				var uColor	= gl.getUniformLocation(this.program,"uColor");

				gl.uniform3fv(uColor, aryColor);

				gl.useProgram(null); //Done setting up shader
			}
		}
	</script>
</head>
<body>
	<div>
		<canvas id="glcanvas"></canvas>
	</div>
	<script id="vertex_shader" type="x-shader/x-vertex">#version 300 es
		in vec3 a_position;
		layout(location=4) in float a_color;
		
		uniform mat4 uMVMatrix;
		uniform vec3 uColor[4];

		out lowp vec4 color;

		void main(void){
			color = vec4(uColor[int(a_color)],1.0);
			gl_Position = uMVMatrix * vec4(a_position,1.0);
		}
	</script>
	<script id="fragment_shader" type="x-shader/x-fragment">#version 300 es
		precision mediump float;

		in vec4 color;
		out vec4 finalColor;
		
		void main(void) {
			finalColor = color;
		}
	</script>
</body>
</html>